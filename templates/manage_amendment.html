{% extends "base.html" %}
{% block title %}Manage Amendment{% endblock %}

{% block content %}
<div class="container py-4">

  <h2 class="page-title mb-4">ğŸ› ï¸ Manage SOP Amendment</h2>

  <div class="text-end mb-3">
  <a href="{{ url_for('amendments_page') }}" class="btn btn-outline-secondary">
    ğŸ”™ Back to Amendments
  </a>
</div>

  <!-- Tabs Layout -->
  <ul class="nav nav-tabs mb-4" id="amendmentTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-stage1" data-bs-toggle="tab" data-bs-target="#stage1" type="button" role="tab">
        ğŸ“ Stage 1: Raise/Edit
      </button>
    </li>
    {% if session.get('role') in ['admin', 'hod'] and amendment %}
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-stage2" data-bs-toggle="tab" data-bs-target="#stage2" type="button" role="tab">
        ğŸ” Stage 2: Review & Consensus
      </button>
    </li>
    {% endif %}
  </ul>

  <div class="tab-content" id="amendmentTabsContent">

    <!-- Stage 1: Raise/Edit -->
    <div class="tab-pane fade show active" id="stage1" role="tabpanel">
      <form method="post">
        <div class="card shadow-sm border border-primary">
          <div class="card-body">
            <div class="row g-3">

              <div class="col-md-6">
                <label class="form-label">SOP</label>
                <select name="sop_id" class="form-select" required {% if amendment %}disabled{% endif %}>
                  {% for sop in sops %}
                    <option value="{{ sop.id }}" {% if amendment and amendment.sop_id == sop.id %}selected{% endif %}>
                      {{ sop.filename }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">SOP Section</label>
                <input type="text" name="sop_section" value="{{ amendment.sop_section if amendment else '' }}" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Details of Amendment</label>
                <textarea name="details" class="form-control" rows="3" required>{{ amendment.details if amendment else '' }}</textarea>
              </div>

              <div class="col-md-6">
                <label class="form-label">Suggested Change</label>
                <textarea name="suggestion" class="form-control" rows="3">{{ amendment.suggestion if amendment else '' }}</textarea>
              </div>

              <div class="col-md-4">
                <label class="form-label">Severity</label>
                <select name="severity" class="form-select">
                  {% for level in ['Any','Critical','High','Medium','Low','Major','Minor','Query','Very High','Very Low'] %}
                  <option value="{{ level }}" {% if amendment and amendment.severity == level %}selected{% endif %}>{{ level }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Status</label>
                <select name="status" class="form-select" {% if amendment and amendment.status == 'final' %}disabled{% endif %}>
                  <option value="draft" {% if amendment and amendment.status == 'draft' %}selected{% endif %}>Draft</option>
                  <option value="final" {% if amendment and amendment.status == 'final' %}selected{% endif %}>Final</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Raised By</label>
                <input type="text" class="form-control" value="{{ amendment.raised_by if amendment else session.username }}" readonly>
              </div>

              <div class="col-md-4">
                <label class="form-label">Date Raised</label>
                <input type="text" class="form-control" value="{{ amendment.date_raised.strftime('%Y-%m-%d') if amendment else now.strftime('%Y-%m-%d') }}" readonly>
              </div>

              <div class="col-md-4">
                <label class="form-label">SOP Version</label>
                <input type="text" class="form-control" value="{{ amendment.sop_version if amendment else '' }}" readonly>
              </div>

              <div class="col-md-4">
                <label class="form-label">Owner</label>
                <input type="text" class="form-control" value="{{ amendment.owner if amendment else '' }}" readonly>
              </div>

              {% if amendment %}
              <div class="col-md-3">
                <label class="form-label">Age (Days)</label>
                <input type="text" class="form-control" value="{{ (now - amendment.date_raised).days }}" readonly>
              </div>
              {% endif %}

            </div>

            <div class="mt-4 text-end">
              <button type="submit" class="btn btn-success">
                {% if amendment %}Update{% else %}Submit{% endif %} Amendment
              </button>
            </div>

          </div>
        </div>
      </form>
    </div>

    <!-- Stage 2: Review & Consensus -->
    {% if session.get('role') in ['admin', 'hod'] and amendment %}
    <div class="tab-pane fade" id="stage2" role="tabpanel">
      <form method="post" action="{{ url_for('review_amendment', amendment_id=amendment.id) }}">
        <div class="card shadow-sm border border-secondary mt-4">
          <div class="card-body">
            <h5 class="text-secondary mb-3">Review and Consensus</h5>
            <div class="row g-3">

              <div class="col-md-12">
                <label class="form-label">Update Details</label>
                <textarea name="update_details" class="form-control" rows="3" required>{{ amendment.update_details or '' }}</textarea>
              </div>

              <div class="col-md-4">
                <div class="form-check mt-2">
                  <input type="checkbox" name="consensus" class="form-check-input" {% if amendment.consensus_reached %}checked{% endif %}>
                  <label class="form-check-label">Consensus Reached</label>
                </div>
              </div>

              <div class="col-md-4">
                <label class="form-label">New Version</label>
                <input type="text" name="new_version" value="{{ amendment.new_version or '' }}" class="form-control" placeholder="e.g. 2.1">
              </div>

              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">Submit Review</button>
              </div>

            </div>
          </div>
        </div>
      </form>

  {% if amendment.updated_by %}
  <!-- Stage 2 Summary Card -->
  <div class="card shadow-sm mt-4">
    <div class="card-header bg-info text-white">
      <strong>ğŸ§¾ Stage 2: Requested Amendment Details</strong>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Amended By</label>
          <input type="text" class="form-control" value="{{ amendment.updated_by }}" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Amended Date</label>
          <input type="text" class="form-control" value="{{ amendment.update_date.strftime('%Y-%m-%d') if amendment.update_date else 'â€”' }}" readonly>
        </div>
        <div class="col-md-4">
          <label class="form-label">Consensus Reached?</label>
          <input type="text" class="form-control" value="{{ 'Yes' if amendment.consensus_reached else 'No' }}" readonly>
        </div>
      </div>

      <div class="mt-3">
        <label class="form-label">Amended Details</label>
        <textarea class="form-control" readonly rows="3">{{ amendment.update_details }}</textarea>
      </div>
    </div>
  </div>
  {% endif %}


{% if session.get('role') in ['admin', 'hod'] and reviewed_amendments %}
<!-- Stage 2 Reviews Table -->
<div class="card shadow-sm border border-info mt-5">
  <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
    <strong>ğŸ“‹ All Submitted Reviews</strong>
    <button onclick="downloadTable()" class="btn btn-light btn-sm">â¬‡ï¸ Download Excel</button>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table id="reviewTable" class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>SOP</th>
            <th>Section</th>
            <th>Amended Details</th>
            <th>Version</th>
            <th>Amended</th>
            <th>By</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {% for rev in reviewed_amendments %}
          <tr>
            <td>{{ rev.sop.filename if rev.sop else 'â€”' }}</td>
            <td>{{ rev.sop_section or 'â€”' }}</td>
            <td>{{ rev.update_details or 'â€”' }}</td>
            <td>{{ rev.new_version or 'â€”' }}</td>
            <td>{{ 'Yes' if rev.consensus_reached else 'No' }}</td>
            <td>{{ rev.updated_by or 'â€”' }}</td>
            <td>{{ rev.update_date.strftime('%Y-%m-%d') if rev.update_date else 'â€”' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Download Table Script -->
<script>
function downloadTable() {
  let table = document.getElementById('reviewTable');
  let rows = Array.from(table.querySelectorAll('tr'));
  let csvContent = rows.map(row => {
    let cells = Array.from(row.querySelectorAll('th, td'));
    return cells.map(cell => `"${cell.innerText}"`).join(',');
  }).join('\n');

  let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  let url = URL.createObjectURL(blob);
  let link = document.createElement('a');
  link.setAttribute('href', url);
  link.setAttribute('download', 'all_stage2_reviews.csv');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
{% endif %}



    </div>
    {% endif %}

  </div>
</div>

<script>
// Auto-select correct tab after page load
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const tab = urlParams.get('tab');

  if (tab === 'stage2') {
    const stage2Tab = document.getElementById('tab-stage2');
    if (stage2Tab) {
      new bootstrap.Tab(stage2Tab).show();
    }
  } else {
    const stage1Tab = document.getElementById('tab-stage1');
    if (stage1Tab) {
      new bootstrap.Tab(stage1Tab).show();
    }
  }
});
</script>


{% endblock %}
